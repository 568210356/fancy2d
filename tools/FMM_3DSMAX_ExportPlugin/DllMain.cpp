////////////////////////////////////////////////////////////////////////////////
/// @brief DLLMain
/// @note  定义了3dsmax标准的导出函数
////////////////////////////////////////////////////////////////////////////////

#include "FMMExporterDesc.h"

/// @brief 全局DLL实例
HINSTANCE g_hDllInstance;

////////////////////////////////////////////////////////////////////////////////
/// @brief DllMain实现
////////////////////////////////////////////////////////////////////////////////
BOOL WINAPI DllMain(HINSTANCE hinstDLL,ULONG fdwReason,LPVOID lpvReserved)
{
	if( fdwReason == DLL_PROCESS_ATTACH )
	{
		// 记下DLL实例句柄
		g_hDllInstance = hinstDLL;

		// 保证新线程不再调用DllMain
		DisableThreadLibraryCalls(g_hDllInstance);
	}

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////
/// @brief DLL辅助函数 - 资源ID取字符串
////////////////////////////////////////////////////////////////////////////////
std::string GetResString(UINT ResID)
{
   char sTextBuffer[1024];

   if(g_hDllInstance)
	   if(LoadString(g_hDllInstance, ResID, sTextBuffer, sizeof(sTextBuffer)/sizeof(char)))
	   {
		   return sTextBuffer;
	   }

	return "";
}

////////////////////////////////////////////////////////////////////////////////
/// @brief 插件描述
////////////////////////////////////////////////////////////////////////////////
__declspec( dllexport ) LPCSTR LibDescription()
{
   static std::string s_LibDesc = GetResString(IDS_PLUGIN_DESC);

   return s_LibDesc.c_str();
}

////////////////////////////////////////////////////////////////////////////////
/// @brief 插件所能提供的类数量
////////////////////////////////////////////////////////////////////////////////
__declspec( dllexport ) int LibNumberClasses()
{
   return 1;
}

////////////////////////////////////////////////////////////////////////////////
/// @brief 返回插件描述
////////////////////////////////////////////////////////////////////////////////
__declspec( dllexport ) ClassDesc* LibClassDesc(int i)
{
	switch(i) {
	case 0:
		return CFMMExporterDesc::GetInstance();
	default:
		return NULL;
	}
}

////////////////////////////////////////////////////////////////////////////////
/// @brief 返回插件支持的3dsMax版本
////////////////////////////////////////////////////////////////////////////////
__declspec( dllexport ) ULONG LibVersion()
{
   return VERSION_3DSMAX;
}

////////////////////////////////////////////////////////////////////////////////
/// @brief 指明插件是否允许延迟加载
////////////////////////////////////////////////////////////////////////////////
__declspec( dllexport ) ULONG CanAutoDefer()
{
   return TRUE;
}
